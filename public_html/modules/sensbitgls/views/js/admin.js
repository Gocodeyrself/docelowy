var sensbitgls=function(o){var r=this,c=!1,d=!1,l={id_order:"",ajax_url_packages:"",next_package_id:1,google_key:"AIzaSyDZc6Ajf0PqhUAzbktozQyHFpi5V7TZW_o",callback_queue:{}};function p(e){var n={};return e.find(".param").each(function(e,a){var t="",t=o(this).is(":checkbox")?o(this).is(":checked")?1:0:o(this).val();n[o(this).attr("name")]=t}),n}function u(e,a,t,n){n=void 0!==n&&n;var s=e.find(".message");s.removeClass("success warning danger").addClass(t),s.html(a),s.fadeIn(),n?setTimeout(function(){s.fadeOut(),i()},1e3):i()}function i(){o(".sensbitgls .messages-container .message").each(function(){var e=o(this),a=e.parents("tr"),t=e.parents(".messages-container");e.css("top",a.offset().top-t.offset().top),e.css("height",a.height()),e.css("line-height",a.height()+"px")})}function f(){var e,a=o(".sensbitgls-orders-selected-container");a.length&&(e=o(".sensbitgls .package input[name='checked']:checked").length,(o(".sensbitgls .package.error input[name='checked']:checked").length?(a.find(".prepare-packs").hide(),a.find(".next-error")):(a.find(".next-error").hide(),a.find(".prepare-packs"))).fadeIn().css("display","block"),a.find(".n").text(e),0<e?a.css("top","0px"):a.removeAttr("style"))}return o(function(){o(document).ajaxSuccess(function(e,a,t){if(void 0!==t.url&&0<=t.url.toLowerCase().search(l.module)){try{void 0===a.responseJSON&&(a.responseJSON=JSON.parse(a.responseText))}catch(e){}void 0!==a.responseJSON&&void 0!==a.responseJSON.callback&&o(a.responseJSON.callback).each(function(e,a){for(var t in a)void 0===l.callback_queue[t]&&(l.callback_queue[t]=[]),l.callback_queue[t].push(a[t])})}}),setInterval(function(){if(0==o.active){for(var e in l.callback_queue)"function"==typeof window[l.module][e]&&window[l.module][e].apply(null,[o.unique(l.callback_queue[e])]);l.callback_queue={}}},1e3),o.fn.tooltip&&(o(".sensbitgls-tip").each(function(){void 0!==o(this).attr("placeholder")&&o(this).attr("title",o(this).attr("placeholder"))}),o(".sensbitgls-tip").tooltip()),o.fn.datetimepicker&&o(".sensbitgls-datetime").datetimepicker({prevText:"",nextText:"",dateFormat:"yy-mm-dd",timeFormat:"hh:mm:ss"}),o(document).on("change","#sensbitgls_pickup_sender_point",function(){r.checkPredefinedPlace()}),o("#sensbitgls_pickup_sender_point").trigger("change"),o(document).on("click",".sensbitgls-service",function(e){e.preventDefault(),r.createServicePackage(o(this).data("id"))});var e=o(".sensbitgls-pack-status[data-autocheck=1]").map(function(){return o(this).data("id-shipment")}).get();0<e.length&&r.getPackStatus(e),o(document).on("change",".sensbitgls .package input[name='checked']",f),o(document).on("change",".sensbitgls-service-order-select",function(e){o(".sensbitgls-service-order-btn[data-id_order="+o(this).data("id_order")+"]").data("id_template",o(this).val())}),o(document).on("click",".sensbitgls-service-order-btn",function(e){e.preventDefault(),r.createServiceOrderPackage(o(this).data("id_order"),o(this).data("id_template"))}),o(document).on("click",".sensbitgls-orders-selected-container .next-error",function(e){o("html, body").animate({scrollTop:o(".sensbitgls .package.error").eq(0).offset().top-150},500)}),o(document).on("click",".sensbitgls-mass-open",function(e){e.preventDefault(),o(".sensbitgls-service-order-btn").trigger("click")}),o(document).on("click",".sensbitgls-mass-add",function(e){e.preventDefault(),o(".sensbitgls-service-order-btn").trigger("click");var a=setInterval(function(){o.active<=0&&(o(".sensbitgls .prepare-packs").trigger("click"),clearInterval(a))},500)}),o(document).on("click",".sensbitgls .prepare-packs",function(e){e.preventDefault(),o(".sensbitgls .package-options").hide(),r.addSelectedPackages()}),o(document).on("click",".sensbitgls .print-labels",function(e){e.preventDefault();var a=[];o(".sensbitgls .completed-packs:checked").each(function(){a.push(o(this).val())}),r.printLabels(a)}),o(document).on("click",".sensbitgls-bulk-labels",function(e){e.preventDefault();var a=[];o(".sensbitgls_shipment input:checked").each(function(){a.push(o(this).val())}),r.printLabels(a)}),o(document).on("click",".sensbitgls-bulk-protocol",function(e){e.preventDefault();var a=[];o(".sensbitgls_shipment input:checked").each(function(){a.push(o(this).val())}),r.printProtocol(a)}),o(document).on("click",".sensbitgls .delete-shipments",function(e){e.preventDefault();var a=[];o(".sensbitgls .completed-packs:checked").each(function(){a.push(o(this).val())}),r.deleteShipments(a)}),o(document).on("click",".sensbitgls .messages-container .message",function(){o(this).closest(".package").removeClass("error"),o(this).fadeOut()}),o(document).on("click",".sensbitgls-orders-filters-open",function(e){e.preventDefault();e=o(".sensbitgls-orders-filters .filters-container");e.toggleClass("open"),e.hasClass("open")?o(this).text("Zwiń ⇈"):o(this).text("Rozwiń ⇊")}),o(document).on("click",".sensbitgls .switch_global_templates",function(e){e.preventDefault(),o(this).closest(".sensbitgls").toggleClass("hide_global_templates")}),o(document).on("click",".sensbitgls .switch_no_templates",function(e){e.preventDefault(),o(this).closest(".sensbitgls").toggleClass("hide_no_templates")}),o(document).on("click",".sensbitgls-slide-toggle",function(e){e.preventDefault();var a=o(this),t=a.attr("href");o(t).length&&o(t).slideToggle(400,function(){o(t).is(":visible")?a.html("Ukryj"):a.html("Pokaż")})})}),r={setOptions:function(e){o.extend(l,e)},setIdOrder:function(e){this.id_order=e},showAlert:function(e){o.prototype.fancybox?o.fancybox.open([{type:"inline",autoScale:!0,minHeight:30,content:'<p class="fancybox-error">'+e+"</p>"}],{padding:0,helpers:{overlay:{locked:!1}}}):alert(e)},bindEventsToPackage:function(e){var t=o(".sensbitgls #package_"+e),a=o(".sensbitgls #package_options_"+e);t.find(".param, .package-param").each(function(){o(this).attr("title",o(this).attr("placeholder"))}),a.find(".param, .package-param").each(function(){o(this).attr("title",o(this).attr("placeholder"))}),o.fn.tooltip&&(t.find(".param, .package-param").tooltip(),a.find(".param, .package-param").tooltip()),t.find(".edit-address").click(function(e){e.preventDefault(),$addr_text=o(this).closest(".address"),$addr_edit=$addr_text.next(".address-edit"),$addr_text.hide(),$addr_edit.fadeIn()}),t.find(".save-address").click(function(e){e.preventDefault(),$addr_edit=o(this).closest(".address-edit"),($addr_text=$addr_edit.prev(".address")).find("div").html([$addr_edit.find("input[name=company]").val(),$addr_edit.find("input[name=firstname]").val()+" "+$addr_edit.find("input[name=lastname]").val(),$addr_edit.find("input[name=street]").val()+" "+$addr_edit.find("input[name=building_number]").val(),$addr_edit.find("input[name=postcode]").val()+" "+$addr_edit.find("input[name=city]").val(),$addr_edit.find("input[name=country_iso_code]").val()].filter(function(e){return 0<e.length}).join("<br/>")),$addr_text.fadeIn(),$addr_edit.hide()}),t.find(".remove-package").click(function(e){e.preventDefault(),a.remove(),t.fadeOut(400,function(){t.closest("table").find(".package").length<=1&&(t.closest("table").hide(),t.closest(".packages-form").hide()),t.remove(),f()})}),t.find(".message").click(function(){t.removeClass("error"),o(this).fadeOut(),f()}),t.find(".show-options").on("click",function(e){e.preventDefault(),a.is(":visible")?(a.fadeOut(),t.removeClass("options-visible")):(a.fadeIn(),t.addClass("options-visible"))}),t.on("click",".copy",function(e){e.preventDefault(),o(this).closest(".subpackage").clone(!1).appendTo(t.find(".subpackages"));var a=1;t.find(".subpackage").each(function(){o(this).find(".number input").val(a++)}),o.fn.tooltip&&t.find(".subpackage .package-param").tooltip()}),t.on("click",".subpackage .remove",function(e){e.preventDefault(),o(this).closest(".subpackage").fadeOut(400,function(){o(this).remove();var e=1;t.find(".subpackage").each(function(){o(this).find(".number input").val(e++)})})}),o.fn.datepicker&&a.find(".sensbitgls_var_shipmentDate").datepicker({prevText:"",nextText:"",minDate:0,maxDate:"+7D",dateFormat:"yy-mm-dd",onSelect:function(e,a){},beforeShowDay:function(e){return[0<e.getDay(),""]}})},openMap:function(e){},update:function(){o.ajax({type:"POST",data:{ajax:1,sensbitgls:1,action:"update"},beforeSend:function(){showNoticeMessage("Aktualizacja bazy danych modułu GLS")},error:function(e,a,t){showErrorMessage(a)},success:function(e){void 0!==e.errors?showErrorMessage(e.errors.join(", ")):showSuccessMessage("Aktualizacja bazy danych modułu GLS przebiegła pomyślnie")}})},createServiceOrderPackage:function(n,e){var s=n+"_"+l.next_package_id,i=0<o("#sensbitgls-order-form-"+n).length?0:1;o.ajax({type:"POST",url:l.ajax_url_packages,dataType:"json",data:{ajax:1,action:"getNewPackageForm",id_template:e,id_order:n,uniq:s,full:i},beforeSend:function(){++l.next_package_id},success:function(e){var a,t;i?(t=(a=o(".sensbitgls-service-order-select[data-id_order="+n+"]").closest("tr")).find("td").length,(t=o("<tr><td colspan='"+t+" style='padding:0'></td></tr>")).addClass(a.attr("class")),t.find("td").append(e.html),a.after(t)):(o("#sensbitgls-order-form-"+n).fadeIn(),o("#sensbitgls-order-form-"+n).find(".package-container").append(e.html)),void 0!==e.errors&&0<e.errors.length&&u(o(".sensbitgls #package_"+s),e.errors,"warning"),r.bindEventsToPackage(s),f()}})},createServicePackage:function(e){var a=l.id_order+"_"+l.next_package_id;o.ajax({type:"POST",url:l.ajax_url_packages,dataType:"json",data:{ajax:1,action:"getNewPackageForm",id_template:e,id_order:l.id_order,uniq:a},beforeSend:function(){++l.next_package_id},success:function(e){o(".sensbitgls .packages-form table:hidden").show(),o(".sensbitgls .packages-form:hidden").fadeIn(),o(".sensbitgls .package-container").append(e.html),void 0!==e.errors&&0<e.errors.length&&u(o(".sensbitgls #package_"+a),e.errors,"warning"),r.bindEventsToPackage(a)}})},addSelectedPackages:function(){d=c=!1;i=[],o(".sensbitgls .package input[name='checked']:checked").each(function(e,a){var a=o(a).closest(".package"),t=o(".sensbitgls #package_options_"+a.data("id")),n=p(a),s=(o.extend(n,p(t)),[]);a.find(".subpackage").each(function(){var e={};o(this).find("input[name]").each(function(){e[o(this).attr("name")]=o(this).val()}),s.push(e)}),o.extend(n,{subpackages:s}),i.push(n)});var i,e=i;e.length<=0?r.showAlert("Nie wybrano żadnych paczek"):o(e).each(function(){var e,a,t=this,n=o(".sensbitgls #package_"+t.uniq),s=[];1==t.cod&&parseFloat(t.cod_value)<=0&&s.push("Nieprawidłowa kwota pobrania"),t.masa<=0&&s.push("Masa przesyłki jest nieprawidłowa."),l.validate_fields_length&&(40<t.notes.length&&s.push("Pole uwagi zawiera zbyt dużo znaków. Max 40."),25<t.reference.length&&s.push("Pole opis przesyłki zawiera zbyt dużo znaków. Max 25."),o.each(t.subpackages,function(e,a){25<a.package_content.length&&s.push("Pole zawartość paczki nr "+(e+1)+"  zawiera zbyt dużo znaków. Max 25.")})),parseInt(t.is_point)?t.id_point.length<=0&&s.push("Nie podano punktu odbioru przesyłki"):(t.firstname.length<=0&&s.push("Błędne imię odbiorcy"),t.lastname.length<=0&&s.push("Błędne nazwisko odbiorcy"),t.street.length<=0&&s.push("Nie podano ulicy odbiorcy"),0<t.validate_street_nbr&&t.building_number.length<=0&&s.push("Nie podano numeru budynku / mieszkania"),t.postcode.length<=0&&s.push("Kod pocztowy odbiorcy jest nieprawidłowy"),t.city.length<=0&&s.push("Błędne miasto odbiorcy"),2!==t.country_iso_code.length&&s.push("Błędny kod kraju odbiorcy. 2 znaki max.")),s.length?(n.addClass("error"),u(n,"Popraw następujące błędy: "+s.join(", "),"danger"),f()):(e=0,(a=function(){var a;!0===c?(clearInterval(e),a=n,o.ajax({type:"POST",url:l.ajax_url_packages,dataType:"json",data:{ajax:1,action:"sendPackage",pack:t},beforeSend:function(e){a.removeClass("error"),u(a,"Trwa przygotowywanie przesyłki","warning")},success:function(e){void 0!==e.errors?(a.addClass("error"),u(a,e.errors.join(", "),"danger",!1)):void 0!==e.status&&"completed"==e.status&&(o(".sensbitgls .packages-ready-form:hidden").fadeIn(),o(".sensbitgls .packages-ready-container:hidden").fadeIn(),o(e.packs).each(function(){var e=this;o(".sensbitgls .packages-ready-container").append(e.pack),void 0!==e.tracking_number&&(o(".sensbitgls-shipment-list[data-id_order="+e.id_order+"]").append('<a class="sensbitgls-tip" title="Pobiera etykietę dla przesyłki o nr '+e.tracking_number+'" href="#" style="color:#0c0;" onclick="sensbitgls.printLabels('+e.id_shipment+');return false;">'+e.tracking_number+"</a>"),o(".sensbitgls-shipment-list .sensbitgls-tip").tooltip())}),a.fadeOut(400,function(){a.closest("table").find(".package").length<=1&&(a.closest("table").hide(),a.closest(".packages-form").hide()),a.remove(),f()}))}})):d?u(n,"Oczekiwanie na sesję","warning"):(d=!0,o.ajax({type:"POST",url:l.ajax_url_packages,dataType:"json",data:{ajax:1,action:"getSession"},beforeSend:function(e){u(n,"Oczekiwanie na sesję","warning")},success:function(e){c=0<e.id,(!e.id||e.id<=0)&&(d=!1),e.id<=0&&showErrorMessage("Wystąpił błąd z pobieraniem aktywnej sesji. Sprawdź dane logowania w konfiguracji.")}}))})(),setTimeout(function(){e=setInterval(a,1e3)},1e3))})},printLabels:function(e){o.ajax({type:"POST",url:l.ajax_url_packages,dataType:"json",data:{ajax:1,action:"printLabels",id_shipment:e},beforeSend:function(e){showSuccessMessage("Generowanie etykiet")},success:function(e){void 0!==e.errors?r.showAlert(e.errors.join(", ")):o.each(e.files,function(e,a){a=l.ajax_url_packages+"&ajax=1&action=getLabelFile&file="+a.file+"&filename="+a.filename+"&format="+a.format;o("<iframe></iframe>").hide().attr("src",a).appendTo(o("body")).load(function(){var e=this;setTimeout(function(){o(e).remove()},100)})})}})},printNode:function(e){o.ajax({type:"POST",url:l.ajax_url_packages,dataType:"json",data:{ajax:1,action:"printNode",id_shipment:e},beforeSend:function(e){showSuccessMessage("Wysyłanie etykiet do usługi PrintNode.com")},success:function(e){void 0!==e.errors?r.showAlert(e.errors.join("<br/>")):showSuccessMessage("Wysyłanie etykiet do usługi PrintNode.com przebiegło pomyślnie.")}})},printLabelsByProtocolId:function(e){o.ajax({type:"POST",url:l.ajax_url_packages,dataType:"json",data:{ajax:1,action:"printLabelsByProtocolId",id_protocol:e},beforeSend:function(e){showSuccessMessage("Generowanie etykiet z protokołu")},success:function(e){void 0!==e.errors?r.showAlert(e.errors.join(", ")):o.each(e.files,function(e,a){a=l.ajax_url_packages+"&ajax=1&action=getLabelFile&file="+a.file+"&filename="+a.filename+"&format="+a.format;o("<iframe></iframe>").hide().attr("src",a).appendTo(o("body")).load(function(){var e=this;setTimeout(function(){o(e).remove()},100)})})}})},printLabelsByDispatchId:function(e){o.ajax({type:"POST",url:l.ajax_url_packages,dataType:"json",data:{ajax:1,action:"printLabelsByDispatchId",id_dispatch_order:e},beforeSend:function(e){showSuccessMessage("Generowanie etykiet z protokołu")},success:function(e){void 0!==e.errors?r.showAlert(e.errors.join(", ")):o.each(e.files,function(e,a){a=l.ajax_url_packages+"&ajax=1&action=getLabelFile&file="+a.file+"&filename="+a.filename+"&format="+a.format;o("<iframe></iframe>").hide().attr("src",a).appendTo(o("body")).load(function(){var e=this;setTimeout(function(){o(e).remove()},100)})})}})},printProtocol:function(e){o.ajax({type:"POST",url:l.ajax_url_packages,dataType:"json",data:{ajax:1,action:"printProtocol",id_shipment:e},beforeSend:function(e){showSuccessMessage("Generowanie protokołu")},success:function(e){void 0!==e.errors?r.showAlert(e.errors.join(", ")):o.each(e.files,function(e,a){a=l.ajax_url_packages+"&ajax=1&action=getLabelFile&file="+a.file+"&filename="+a.filename+"&format="+a.format;o("<iframe></iframe>").hide().attr("src",a).appendTo(o("body")).load(function(){var e=this;setTimeout(function(){o(e).remove()},100)})})}})},printProtocolById:function(e){o.ajax({type:"POST",url:l.ajax_url_packages,dataType:"json",data:{ajax:1,action:"printProtocolById",id_protocol:e},beforeSend:function(e){showSuccessMessage("Pobieranie protokołu")},success:function(e){void 0!==e.errors?r.showAlert(e.errors.join(", ")):o.each(e.files,function(e,a){a=l.ajax_url_packages+"&ajax=1&action=getLabelFile&file="+a.file+"&filename="+a.filename+"&format="+a.format;o("<iframe></iframe>").hide().attr("src",a).appendTo(o("body")).load(function(){var e=this;setTimeout(function(){o(e).remove()},100)})})}})},printProtocolByDispatchId:function(e){o.ajax({type:"POST",url:l.ajax_url_packages,dataType:"json",data:{ajax:1,action:"printProtocolByDispatchId",id_dispatch_order:e},beforeSend:function(e){showSuccessMessage("Generowanie protokołu")},success:function(e){void 0!==e.errors?r.showAlert(e.errors.join(", ")):o.each(e.files,function(e,a){a=l.ajax_url_packages+"&ajax=1&action=getLabelFile&file="+a.file+"&filename="+a.filename+"&format="+a.format;o("<iframe></iframe>").hide().attr("src",a).appendTo(o("body")).load(function(){var e=this;setTimeout(function(){o(e).remove()},100)})})}})},getPackStatus:function(a){a instanceof Array||(a=[a]),o.ajax({type:"POST",url:l.ajax_url_packages,dataType:"json",data:{ajax:1,action:"getPackStatus",id_shipment:a},beforeSend:function(e){o.each(a,function(){o(".sensbitgls-pack-status[data-id-shipment="+this+"]").removeClass("new old").addClass("check")})},success:function(e){void 0!==e.errors?r.showAlert(e.errors.join(", ")):o.each(e.data,function(e,a){var e=o(".sensbitgls-pack-status[data-id-shipment="+e+"]"),t=e.text();void 0!==a.error?(e.text(a.status),e.removeClass("check new old").addClass("err")):t!==a.status?(e.text(a.status),e.removeClass("check old").addClass("new"),showSuccessMessage("Przesyłka "+a.tracking_number+" otrzymała nowy status: "+a.status)):e.removeClass("check new").addClass("old")})}})},deleteShipments:function(e){o.isArray(e)||(e=[e]),o(e).each(function(){var e=parseInt(this),a=o(".sensbitgls #shipment_"+e);o.ajax({type:"POST",url:l.ajax_url_packages,dataType:"json",data:{ajax:1,action:"deleteShipment",id_shipment:e},beforeSend:function(e){u(a,"Trwa usuwanie przesyłki","warning",!1)},success:function(e){void 0!==e.errors?u(a,e.errors.join(", "),"danger"):(u(a,"Przesyłka została usunięta z systemu","success"),a.find(".message").click(function(){a.fadeOut(400,function(){o(this).remove()})}))}})})},initSwitches:function(e){function n(){e.forEach(function(e){var a=e[0],t=e[1],e=e[2],n=(t=parseInt(t)<=0?"":":lt("+t+")",parseInt(o(a+":checked").val()));a=""===t?o(a).closest("div.form-group").not(".blocked").nextAll("div.form-group"):o(a).closest("div.form-group").not(".blocked").nextAll(t),n===e?a.slideDown():a.slideUp()})}e=o.map(e,function(e){var a=e[0],t=e[1],e=e[2];return o("input[name="+a+"]").on("change",function(){n()}),[["input[name="+a+"]",t,e]]}),n()},checkPredefinedPlace:function(){var e=o("#sensbitgls_pickup_sender_point :selected");e.length&&void 0!==(e=e.data("json"))&&(o("input[name='pickupSender[senderName]'").css("opacity",0).val(e.company).animate({opacity:1},300),o("input[name='pickupSender[senderFullName]'").css("opacity",0).val(e.name).animate({opacity:1},300),o("input[name='pickupSender[senderAddress]'").css("opacity",0).val(e.address).animate({opacity:1},300),o("input[name='pickupSender[senderCity]'").css("opacity",0).val(e.city).animate({opacity:1},300),o("input[name='pickupSender[senderPostalCode]'").css("opacity",0).val(e.post_code).animate({opacity:1},300),o("input[name='pickupSender[senderPhone]'").css("opacity",0).val(e.phone).animate({opacity:1},300))},updateShippingTable:function(e){var a=o("#shipping_table");a.length&&o.ajax({type:"POST",url:l.ajax_url_packages,dataType:"json",data:{ajax:1,action:"getShippingTable",id_order:e},beforeSend:function(e){showSuccessMessage("Aktualizowanie tabeli przewoźników")},success:function(e){void 0!==e.errors?r.showAlert(e.errors.join(", ")):void 0!==e.content&&(a.find("tbody").html(e.content),showSuccessMessage("Tabela przewoźników została zaktualizowana."))}})}}}($,(window,document));